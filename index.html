<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>forecast-model-vis</title>

<link rel="icon" href="data:,">

<!-- MapLibre -->
<link href="https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  margin: 0;
  background: #0f0f0f;
  color: #ddd;
  font-family: system-ui, sans-serif;
}

#map {
  width: 100vw;
  height: 100vh;
}

#panel {
  position: absolute;
  top: 20px;
  right: 20px;
  width: 420px;
  max-height: 90vh;
  overflow-y: auto;
  background: rgba(20,20,20,0.96);
  padding: 16px;
  border-radius: 8px;
  font-size: 14px;
}

h2 { margin: 0 0 12px 0; }

label { display:block; margin-top:8px; }

canvas { margin-top: 20px; }
</style>
</head>

<body>

<div id="map"></div>

<div id="panel">
  <h2>forecast-model-vis</h2>

  <strong>Select Models</strong>

  <label><input type="checkbox" value="gfs" checked> GFS</label>
  <label><input type="checkbox" value="icon"> ICON</label>
  <label><input type="checkbox" value="ukmo"> UKMO</label>
  <label><input type="checkbox" value="meteofrance"> MeteoFrance</label>
  <label><input type="checkbox" value="ecmwf"> ECMWF (IFS 9km)</label>

  <div id="content" style="margin-top:12px;">
    Click anywhere on the map.
  </div>

  <canvas id="tempChart"></canvas>
</div>

<script>

/* ================================
   MAP INIT
================================ */
const map = new maplibregl.Map({
  container: 'map',
  style: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
  center: [12, 50],
  zoom: 4
});

map.addControl(new maplibregl.NavigationControl());

/* ================================
   GLOBAL STATE
================================ */
let tempChart = null;
let lastLat = null;
let lastLon = null;

/* ================================
   MODEL COLORS
================================ */
const modelColors = {
  gfs: "#ff6b6b",
  icon: "#4dabf7",
  ukmo: "#ffd43b",
  meteofrance: "#69db7c",
  ecmwf: "#b197fc"
};

/* ================================
   MAP CLICK
================================ */
map.on('click', (e) => {
  const { lng, lat } = e.lngLat;
  lastLat = lat;
  lastLon = lng;
  fetchAllSelectedModels();
});

/* ================================
   FETCH ALL SELECTED MODELS
================================ */
async function fetchAllSelectedModels() {

  const selected = Array.from(
    document.querySelectorAll("input[type=checkbox]:checked")
  ).map(cb => cb.value);

  if (selected.length === 0) {
    document.getElementById("content").innerHTML = "Select at least one model.";
    return;
  }

  document.getElementById("content").innerHTML = "Loading forecasts...";

  const fetchPromises = selected.map(model => fetchModel(model));

  try {
    const results = await Promise.all(fetchPromises);
    renderComparison(results.filter(r => r !== null));
  } catch (err) {
    document.getElementById("content").innerHTML = "Error fetching data.";
  }
}

/* ================================
   FETCH SINGLE MODEL
================================ */
async function fetchModel(modelKey) {

  let url;

  if (modelKey === "ecmwf") {
    url = `https://api.open-meteo.com/v1/ecmwf?latitude=${lastLat}&longitude=${lastLon}&hourly=temperature_2m&timezone=auto`;
  } else {
    url = `https://api.open-meteo.com/v1/forecast?latitude=${lastLat}&longitude=${lastLon}&hourly=temperature_2m&model=${modelKey}&timezone=auto`;
  }

  try {
    const response = await fetch(url);
    if (!response.ok) return null;

    const data = await response.json();

    return {
      model: modelKey.toUpperCase(),
      times: data.hourly.time.slice(0, 48),
      temps: data.hourly.temperature_2m.slice(0, 48)
    };

  } catch {
    return null;
  }
}

/* ================================
   RENDER COMPARISON
================================ */
function renderComparison(modelDataArray) {

  if (modelDataArray.length === 0) {
    document.getElementById("content").innerHTML = "No valid model data.";
    return;
  }

  document.getElementById("content").innerHTML = `
    <strong>Location:</strong><br>
    ${lastLat.toFixed(2)}, ${lastLon.toFixed(2)}<br>
    Comparing ${modelDataArray.length} model(s)
  `;

  if (tempChart) tempChart.destroy();

  const ctx = document.getElementById('tempChart').getContext('2d');

  const datasets = modelDataArray.map(model => ({
    label: model.model,
    data: model.temps,
    borderColor: modelColors[model.model.toLowerCase()],
    tension: 0.3,
    pointRadius: 0,
    fill: false
  }));

  tempChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: modelDataArray[0].times,
      datasets: datasets
    },
    options: {
      responsive: true,
      scales: {
        x: {
          ticks: { color: '#aaa', maxTicksLimit: 8 }
        },
        y: {
          ticks: { color: '#aaa' }
        }
      },
      plugins: {
        legend: {
          labels: { color: '#ddd' }
        }
      }
    }
  });
}

</script>

</body>
</html>
