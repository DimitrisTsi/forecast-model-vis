<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>forecast-model-vis</title>

<link rel="icon" href="data:,">

<!-- MapLibre -->
<link href="https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  margin: 0;
  background: #0f0f0f;
  color: #ddd;
  font-family: system-ui, sans-serif;
}

#map {
  width: 100vw;
  height: 100vh;
}

#panel {
  position: absolute;
  top: 20px;
  right: 20px;
  width: 400px;
  max-height: 90vh;
  overflow-y: auto;
  background: rgba(20,20,20,0.96);
  padding: 16px;
  border-radius: 8px;
  font-size: 14px;
}

h2 {
  margin: 0 0 12px 0;
}

select {
  width: 100%;
  padding: 6px;
  margin-bottom: 12px;
  background: #222;
  color: #ddd;
  border: 1px solid #444;
}

canvas {
  margin-top: 20px;
}
</style>
</head>

<body>

<div id="map"></div>

<div id="panel">
  <h2>forecast-model-vis</h2>

  <label>Model</label>
  <select id="modelSelect">
    <option value="gfs">GFS (~0.25°)</option>
    <option value="icon">ICON (~0.25°)</option>
  </select>

  <div id="content">
    Click anywhere on the map.
  </div>

  <canvas id="tempChart"></canvas>
  <canvas id="precipChart"></canvas>
</div>

<script>
/* ===================================
   MAP INIT
=================================== */
const map = new maplibregl.Map({
  container: 'map',
  style: 'https://demotiles.maplibre.org/style.json',
  center: [12, 50],
  zoom: 4
});

map.addControl(new maplibregl.NavigationControl());

/* ===================================
   GLOBAL STATE
=================================== */
let tempChart = null;
let precipChart = null;
let lastLat = null;
let lastLon = null;

/* ===================================
   MODEL CONFIG
=================================== */
const modelConfig = {
  gfs: {
    endpoint: "https://api.open-meteo.com/v1/gfs",
    label: "GFS",
    resolution: "~0.25°"
  },
  icon: {
    endpoint: "https://api.open-meteo.com/v1/icon",
    label: "ICON",
    resolution: "~0.25°"
  }
};

/* ===================================
   MAP CLICK
=================================== */
map.on('click', (e) => {
  const { lng, lat } = e.lngLat;
  lastLat = lat;
  lastLon = lng;
  fetchForecast();
});

/* ===================================
   MODEL SWITCH HANDLER
=================================== */
document.getElementById("modelSelect").addEventListener("change", () => {
  if (lastLat && lastLon) {
    fetchForecast();
  }
});

/* ===================================
   FETCH FORECAST
=================================== */
async function fetchForecast() {

  const modelKey = document.getElementById("modelSelect").value;
  const model = modelConfig[modelKey];

  document.getElementById("content").innerHTML = "Loading forecast...";

  const url = `${model.endpoint}?latitude=${lastLat}&longitude=${lastLon}&hourly=temperature_2m,precipitation,wind_speed_10m&timezone=auto`;

  try {
    const response = await fetch(url);
    const data = await response.json();
    displayForecast(data, model);
  } catch (err) {
    document.getElementById("content").innerHTML = "Error fetching forecast.";
  }
}

/* ===================================
   DISPLAY FORECAST
=================================== */
function displayForecast(data, model) {

  const times = data.hourly.time.slice(0, 48);
  const temps = data.hourly.temperature_2m.slice(0, 48);
  const precip = data.hourly.precipitation.slice(0, 48);

  document.getElementById("content").innerHTML = `
    <strong>Location:</strong><br>
    ${lastLat.toFixed(2)}, ${lastLon.toFixed(2)}<br><br>
    <strong>Model:</strong> ${model.label}<br>
    <strong>Resolution:</strong> ${model.resolution}<br>
    <strong>Window:</strong> Next 48h
  `;

  if (tempChart) tempChart.destroy();
  if (precipChart) precipChart.destroy();

  const tempCtx = document.getElementById('tempChart').getContext('2d');
  const precipCtx = document.getElementById('precipChart').getContext('2d');

  tempChart = new Chart(tempCtx, {
    type: 'line',
    data: {
      labels: times,
      datasets: [{
        label: `${model.label} Temperature (°C)`,
        data: temps,
        borderColor: '#ff6b6b',
        backgroundColor: 'rgba(255,107,107,0.15)',
        tension: 0.3,
        pointRadius: 0
      }]
    },
    options: chartOptions()
  });

  precipChart = new Chart(precipCtx, {
    type: 'bar',
    data: {
      labels: times,
      datasets: [{
        label: `${model.label} Precipitation (mm)`,
        data: precip,
        backgroundColor: '#4dabf7'
      }]
    },
    options: chartOptions()
  });
}

/* ===================================
   SHARED CHART OPTIONS
=================================== */
function chartOptions() {
  return {
    responsive: true,
    scales: {
      x: {
        ticks: { color: '#aaa', maxTicksLimit: 8 }
      },
      y: {
        ticks: { color: '#aaa' }
      }
    },
    plugins: {
      legend: {
        labels: { color: '#ddd' }
      }
    }
  };
}
</script>

</body>
</html>
