<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>forecast-model-vis</title>

<link rel="icon" href="data:,">

<!-- MapLibre -->
<link href="https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  margin: 0;
  background: #0f0f0f;
  color: #ddd;
  font-family: system-ui, sans-serif;
}

#map {
  width: 100vw;
  height: 100vh;
}

#panel {
  position: absolute;
  top: 20px;
  right: 20px;
  width: 380px;
  max-height: 90vh;
  overflow-y: auto;
  background: rgba(20,20,20,0.96);
  padding: 16px;
  border-radius: 8px;
  font-size: 14px;
}

h2 {
  margin: 0 0 12px 0;
}

small {
  color: #999;
}

canvas {
  margin-top: 20px;
}
</style>
</head>

<body>

<div id="map"></div>

<div id="panel">
  <h2>forecast-model-vis</h2>
  <div id="content">
    Click anywhere on the map.
  </div>

  <canvas id="tempChart"></canvas>
  <canvas id="precipChart"></canvas>
</div>

<script>
/* ================================
   MAP INIT
================================ */
const map = new maplibregl.Map({
  container: 'map',
  style: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
  center: [12, 50],
  zoom: 4
});

map.addControl(new maplibregl.NavigationControl());

/* ================================
   GLOBAL CHART REFERENCES
================================ */
let tempChart = null;
let precipChart = null;

/* ================================
   MAP CLICK HANDLER
================================ */
map.on('click', async (e) => {
  const { lng, lat } = e.lngLat;
  fetchForecast(lat, lng);
});

/* ================================
   FETCH FORECAST (GFS - Open Meteo)
================================ */
async function fetchForecast(lat, lon) {

  document.getElementById("content").innerHTML = "Loading forecast...";

  const url = `https://api.open-meteo.com/v1/gfs?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,precipitation,wind_speed_10m&timezone=auto`;

  try {
    const response = await fetch(url);
    const data = await response.json();
    displayForecast(data, lat, lon);
  } catch (err) {
    document.getElementById("content").innerHTML = "Error fetching forecast.";
  }
}

/* ================================
   DISPLAY FORECAST + CHARTS
================================ */
function displayForecast(data, lat, lon) {

  const times = data.hourly.time.slice(0, 48);
  const temps = data.hourly.temperature_2m.slice(0, 48);
  const precip = data.hourly.precipitation.slice(0, 48);

  document.getElementById("content").innerHTML = `
    <strong>Location:</strong><br>
    ${lat.toFixed(2)}, ${lon.toFixed(2)}<br><br>
    <strong>Model:</strong> GFS (Open-Meteo)<br>
    <strong>Resolution:</strong> ~0.25°<br>
    <strong>Forecast Window:</strong> Next 48h
  `;

  // Destroy old charts safely
  if (tempChart) tempChart.destroy();
  if (precipChart) precipChart.destroy();

  const tempCtx = document.getElementById('tempChart').getContext('2d');
  const precipCtx = document.getElementById('precipChart').getContext('2d');

  /* ================================
     TEMPERATURE CHART
  ================================= */
  tempChart = new Chart(tempCtx, {
    type: 'line',
    data: {
      labels: times,
      datasets: [{
        label: 'Temperature (°C)',
        data: temps,
        borderColor: '#ff6b6b',
        backgroundColor: 'rgba(255,107,107,0.15)',
        tension: 0.3,
        pointRadius: 0
      }]
    },
    options: {
      responsive: true,
      scales: {
        x: {
          ticks: { color: '#aaa', maxTicksLimit: 8 }
        },
        y: {
          ticks: { color: '#aaa' }
        }
      },
      plugins: {
        legend: {
          labels: { color: '#ddd' }
        }
      }
    }
  });

  /* ================================
     PRECIPITATION CHART
  ================================= */
  precipChart = new Chart(precipCtx, {
    type: 'bar',
    data: {
      labels: times,
      datasets: [{
        label: 'Precipitation (mm)',
        data: precip,
        backgroundColor: '#4dabf7'
      }]
    },
    options: {
      responsive: true,
      scales: {
        x: {
          ticks: { color: '#aaa', maxTicksLimit: 8 }
        },
        y: {
          ticks: { color: '#aaa' }
        }
      },
      plugins: {
        legend: {
          labels: { color: '#ddd' }
        }
      }
    }
  });
}
</script>

</body>
</html>
